<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mattia Ciurnelli">
    <link rel="icon" href="media/favicon.ico">

    <title>Fab Academy 2015 - Mattia Ciurnelli</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="media/fabacademy.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Rationale|Megrim|Maven+Pro' rel='stylesheet' type='text/css'>
    <link href="media/Mattia.css" rel="stylesheet">
      
    <!-- 3D files viewer -->
    <script type="text/javascript" src="media/jsc3d_ie.min.js"></script>
	<script type="text/javascript" src="media/jsc3d.min.js"></script>
    <script type="text/javascript" src="media/jsc3d.webgl.js"></script>
    <script type="text/javascript" src="media/jsc3d.touch.js"></script>

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="bootstrap/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="bootstrap/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Load the menu file -->
    <script>
	function menu() {
					  $('#exercises').load("exercises-menu.html");
					  $('#project').load("project-menu.html");
					  $('#cclicense').load("license.html");
					  $('#cclicense').load("license.html");
					  }
	</script>

  </head>

  <body onload="menu()">

    <!-- Static navbar -->
    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <strong><a class="navbar-brand" href="index.html">Mattia Ciurnelli</a></strong>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Exercises <span class="caret"></span></a>
              <ul id="exercises" class="dropdown-menu" role="menu">
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Final Project <span class="caret"></span></a>
              <ul id="project" class="dropdown-menu" role="menu">
              </ul>
            </li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

	<!-- Insert your content here below! -->
        <div class="jumbotron">
    <div class="page-header">
  <h1><u> Lesson n. 4:</u><h2>Electronics Production</h2></h1>
</div>

	<p>The Electronics Production assignment is to make the FabISP in-circuit programmer: you have to mill the board, stuff it with components and program it.</p>
        
   <h3>FabISP</h3>
   <p>Initially, here in Opendot, we want to try with different way to make the ISP and compare the results:
<ul type="square">
<li>FabISP done with WIN PC-NC, milled with a 0,5mm tip;</li> 
<li>FabISP done directly engraving the metal with a flexx laser from Trotec;</li></ul></p>
        <p>Unfortunately the milling machine doesn't work, and we started with the direct engraving method.</p>
        <p>For this experiment we used the <a href="http://www.troteclaser.com/it-IT/Macchine-Laser/Medio/Pages/Speedy400flexx.aspx">Trotec Speedy 400 flexx</a>. <p class="pic"><img src= "Image/Lesson04/Laser_trotec.jpg" class="img-responsive" alt="Responsive image"></p>
This kind of Laser Engraving Machine have 2 type of lasers:
        <ul type="square">
            <li>CO<small><sub>2</sub></small> Laser;</li>
            <li>Fiber Laser, that can engrave matel;</li></ul></p>
      <p>Before start engraving our FabISP on the FR1, we do some test with the Speedy 400 (you can see the step of the experimental test on the week 4 page of my mate <a href="http://fabacademy.org/archives/2015/eu/students/bassi.enrico/exercise04.html">Enrico Bassi</a>).</p>
      <h4>Electronics Production</h4>
   <p>Following the tutorial I downloaded the .png file of FabISP and then I imported in Gimp to adapt it for use with the laser cutter: the laser will remove the parts colored black, and leave only those colored white.</p> 
          <p class="pic"><img src= "Image/Lesson04/importazione-bordo.jpg" class="img-responsive" alt="Responsive image"></p>
            <p class="pic"><img src= "Image/Lesson04/FabISP.png" class="img-responsive" alt="Responsive image"></p>
      <p>To optimize the timing of realization we have created, with my mates <a href="http://fabacademy.org/archives/2015/eu/students/silli.saverio/index.html">Saviero Silli</a> and <a href="http://fabacademy.org/archives/2015/eu/students/de_palo.pierluigi/index.html">Pierluigi de Palo</a>, a single file to be sent to print with the laser cutter.</p>
            <p class="pic"><img src= "Image/Lesson04/file_3ISP.jpg" class="img-responsive" alt="Responsive image"></p>
            <p>In the file created with the 3 FabISP, besides the black layer, we have included, in the red layer, the lines for cutting the boards. After completion of the changes to the file, we did start the laser cutter.</p>
      <p class="pic"><img src= "Image/Lesson04/laser_action.jpg" class="img-responsive" alt="Responsive image"></p>
      <p>Here you can see some videos of the laser cutter in action:</p>
     <iframe width="420" height="315" src="https://www.youtube.com/embed/HMdX2siVev0" frameborder="0" allowfullscreen></iframe><br>
      <iframe width="420" height="315" src="https://www.youtube.com/embed/pXH49ZWdGrA" frameborder="0" allowfullscreen></iframe><br>
      <p>This is the result after the engraving:</p>   
      <p class="pic"><img src= "Image/Lesson04/after_laser.jpg" class="img-responsive" alt="Responsive image"></p>
            <p>Once engraved the FR1, I clean with the degreaser to remove the residues of copper powder that had remained on the surface. Below you can see the difference after cleaning:</p>
            <p class="pic"><img src= "Image/Lesson04/after_cleaning.jpg" class="img-responsive" alt="Responsive image"></p>
            <p>Once ready the card, I prepared all the components to be soldered: <ul type="square">
                <li>n. 1 ATTiny 44 microcontroller</li>
                <li>n. 1 Capacitor 1uF</li>
                <li>n. 2 Capacitor 10 pF</li>
                <li>n. 2 Resistor 100 ohm</li>
                <li>n. 1 Resistor 499 ohm</li>
                <li>n. 1 Resistor 1K ohm</li>
                <li>n. 1 Resistor 10K</li>
                <li>n. 1 6 pin header</li>
                <li>n. 1 USB connector</li>
                <li>n. 2 jumpers (1 soldering bridge and 1 0 ohm resistor)</li>
                <li>n. 1 Cystal 20MHz</li>
                <li>n. 2 Zener Diode 3.3 V</li>
                <li>n. 2 6 pin connectors</li>
            </ul></p>
    <p>For soldering I followed the rules on the tutorial and keeping in view the layout of FabISP.</p>
            <p class="pic"><img src= "Image/Lesson04/FabISPPartsLayout.jpg" class="img-responsive" alt="Responsive image"></p>
    <p>The soldering operation took about an hour, and this is the result:</p>
            <p class="pic"><img src= "Image/Lesson04/final_result.jpg" class="img-responsive" alt="Responsive image"></p>
    <p>To verify that everything is soldered correctly we must execute the "smoke test": plug the FabISP into your computer via the mini USB cable and if you're not receiving error messages then it means that everything is working correctly, and you can proceed to programming.</p>

<h4>Programming</h4>
      <p>To program our ISP we need:</p>
    <ul type="square">
        <li>another ISP;</li>
        <li>Avrdude, for programming AVR microcontrollers;</li>
        <li>GCC, to compile C code;</li>
        <li>the FabISP firmware, downloaded from the tutorial page;</li>
    </ul>
    <p>As ISP we used an Arduino UNO, loaded from the Arduino IDE with the sketch "ArduinoISP" that allows you, in fact, to use it as an ISP.</p>
    <p class="pic"><img src= "Image/Lesson04/arduino_ISP.jpg" class="img-responsive" alt="Responsive image"></p>
    <p>We connected the Arduino and FabISP following the diagram below:</p>
    <p class="pic"><img src= "Image/Lesson04/arduino_fabISP_conn.jpg" class="img-responsive" alt="Responsive image"></p>
        <table class="tg" style="undefined;table-layout: fixed; width: 303px" align="center">
        <colgroup>
        <col style="width: 100px">
        <col style="width: 100px">
        <col style="width: 100px">
        </colgroup>
          <tr>
                <td class="tg-hgcj">Signal</td>
                <td class="tg-hgcj">FabISP</td>
                <td class="tg-hgcj">ArduinoUNO</td>
          </tr>
          <tr>
            <td class="tg-e3zv">MISO</td>
            <td class="tg-031e">1</td>
            <td class="tg-031e">12</td>
          </tr>
          <tr>
            <td class="tg-e3zv">VCC</td>
            <td class="tg-031e">2</td>
            <td class="tg-031e">5V</td>
          </tr>
          <tr>
            <td class="tg-e3zv">SCK</td>
            <td class="tg-031e">3</td>
            <td class="tg-031e">13</td>
          </tr>
          <tr>
            <td class="tg-e3zv">MOSI</td>
            <td class="tg-031e">4</td>
            <td class="tg-031e">11</td>
          </tr>
          <tr>
            <td class="tg-e3zv">RESET</td>
            <td class="tg-031e">5</td>
            <td class="tg-031e">10</td>
          </tr>
          <tr>
            <td class="tg-e3zv">GND</td>
            <td class="tg-031e">6</td>
            <td class="tg-031e">GND</td>
          </tr>
        </table><br>
    
    <p>Once connected the two boards, you have to edit the Makefile (which is located in the firmware) to ensure that it works with our ISP: once opened, you have to look for the following two lines and you have to remove the "#" in front of the line with "usbtiny" in it and add a "#" to beginning the line with the "avrisp2" in it to comment it out.</p>
    <div class="notepad">..........
DEVICE  = attiny44
#F_CPU   = 12000000	# edit this line for crystal speed, in Hz
F_CPU   = 20000000	# edit this line for crystal speed, in Hz
FUSE_L  = 0xFF
FUSE_H  = 0xDF
AVRDUDE = avrdude -c usbtiny -p $(DEVICE) # edit this line for your programmer
#AVRDUDE = avrdude -c avrisp2 -P usb -p $(DEVICE) # edit this line for your programmer
.........</div></p>

<p>After editing the Makefile, you have to open the terminal and go to the directory of the firmware:</p>

<div class="code">MacBook-Pro-di-Giulia:~ Giulia$ cd Desktop/FAB\ ACADEMY/fabISP_mac.0.8.2_firmware/
MacBook-Pro-di-Giulia:fabISP_mac.0.8.2_firmware Giulia$ 
</div><br>
<p>Next you need to compile the firmware:</p>
<p>first use the "make clean" command</p>

<div class="code">MacBook-Pro-di-Giulia:fabISP_mac.0.8.2_firmware Giulia$ make clean

rm -f main.hex main.lst main.obj main.cof main.list main.map main.eep.hex main.elf *.o usbdrv/*.o main.s usbdrv/oddebug.s usbdrv/usbdrv.s
</div><br>
<p>then the "make hex"</p>
<div class="code">MacBook-Pro-di-Giulia:fabISP_mac.0.8.2_firmware Giulia$ make hex

avr-gcc -Wall -Os -DF_CPU=20000000	-Iusbdrv -I. -DDEBUG_LEVEL=0 -mmcu=attiny44 -c usbdrv/usbdrv.c -o usbdrv/usbdrv.o

avr-gcc -Wall -Os -DF_CPU=20000000	-Iusbdrv -I. -DDEBUG_LEVEL=0 -mmcu=attiny44 -x assembler-with-cpp -c usbdrv/usbdrvasm.S -o usbdrv/usbdrvasm.o

avr-gcc -Wall -Os -DF_CPU=20000000	-Iusbdrv -I. -DDEBUG_LEVEL=0 -mmcu=attiny44 -c usbdrv/oddebug.c -o usbdrv/oddebug.o

avr-gcc -Wall -Os -DF_CPU=20000000	-Iusbdrv -I. -DDEBUG_LEVEL=0 -mmcu=attiny44 -c main.c -o main.o

main.c:88:13: warning: always_inline function might not be inlinable [-Wattributes]

 static void delay ( void )

             ^

avr-gcc -Wall -Os -DF_CPU=20000000	-Iusbdrv -I. -DDEBUG_LEVEL=0 -mmcu=attiny44 -o main.elf usbdrv/usbdrv.o usbdrv/usbdrvasm.o usbdrv/oddebug.o main.o

rm -f main.hex main.eep.hex

avr-objcopy -j .text -j .data -O ihex main.elf main.hex

avr-size main.hex

   text	  data	    bss	    dec	    hex	filename

      0	  1988	      0	  1988	    7c4	main.hex</div><br>

<p>Next, you need to set the fuses so your board will use the external clock (crystal), usign "make fuse"</p>

<div class="code">MacBook-Pro-di-Giulia:fabISP_mac.0.8.2_firmware Giulia$ sudo make fuse

avrdude -c stk500v1 -P /dev/tty.usbmodem1421 -b19200 -p attiny44 -U hfuse:w:0xDF:m -U lfuse:w:0xFF:m



avrdude: AVR device initialized and ready to accept instructions



Reading | ################################################## | 100% 0.05s



avrdude: Device signature = 0x1e9207

avrdude: reading input file "0xDF"

avrdude: writing hfuse (1 bytes):



Writing | ################################################## | 100% 0.02s



avrdude: 1 bytes of hfuse written

avrdude: verifying hfuse memory against 0xDF:

avrdude: load data hfuse data from input file 0xDF:

avrdude: input file 0xDF contains 1 bytes

avrdude: reading on-chip hfuse data:



Reading | ################################################## | 100% 0.02s



avrdude: verifying ...

avrdude: 1 bytes of hfuse verified

avrdude: reading input file "0xFF"

avrdude: writing lfuse (1 bytes):



Writing | ################################################## | 100% 0.02s



avrdude: 1 bytes of lfuse written

avrdude: verifying lfuse memory against 0xFF:

avrdude: load data lfuse data from input file 0xFF:

avrdude: input file 0xFF contains 1 bytes

avrdude: reading on-chip lfuse data:



Reading | ################################################## | 100% 0.02s



avrdude: verifying ...

avrdude: 1 bytes of lfuse verified



avrdude: safemode: Fuses OK (E:FF, H:DF, L:FF)



avrdude done.  Thank you.</div><br>

<p>Finally you want to program the board to be an ISP, using "make program"</p>

<div class="code">MacBook-Pro-di-Giulia:fabISP_mac.0.8.2_firmware Giulia$ sudo make program

avrdude -c stk500v1 -P /dev/tty.usbmodem1421 -b19200 -p attiny44 -U flash:w:main.hex:i



avrdude: AVR device initialized and ready to accept instructions



Reading | ################################################## | 100% 0.05s



avrdude: Device signature = 0x1e9207

avrdude: NOTE: "flash" memory has been specified, an erase cycle will be performed

         To disable this feature, specify the -D option.

avrdude: erasing chip

avrdude: reading input file "main.hex"

avrdude: writing flash (1988 bytes):



Writing | ################################################## | 100% 3.41s



avrdude: 1988 bytes of flash written

avrdude: verifying flash memory against main.hex:

avrdude: load data flash data from input file main.hex:

avrdude: input file main.hex contains 1988 bytes

avrdude: reading on-chip flash data:



Reading | ################################################## | 100% 2.26s



avrdude: verifying ...

avrdude: 1988 bytes of flash verified



avrdude: safemode: Fuses OK (E:FF, H:DF, L:FF)



avrdude done.  Thank you.



avrdude -c stk500v1 -P /dev/tty.usbmodem1421 -b19200 -p attiny44 -U hfuse:w:0xDF:m -U lfuse:w:0xFF:m



avrdude: AVR device initialized and ready to accept instructions



Reading | ################################################## | 100% 0.05s



avrdude: Device signature = 0x1e9207

avrdude: reading input file "0xDF"

avrdude: writing hfuse (1 bytes):



Writing | ################################################## | 100% 0.02s



avrdude: 1 bytes of hfuse written

avrdude: verifying hfuse memory against 0xDF:

avrdude: load data hfuse data from input file 0xDF:

avrdude: input file 0xDF contains 1 bytes

avrdude: reading on-chip hfuse data:



Reading | ################################################## | 100% 0.02s



avrdude: verifying ...

avrdude: 1 bytes of hfuse verified

avrdude: reading input file "0xFF"

avrdude: writing lfuse (1 bytes):



Writing | ################################################## | 100% 0.02s



avrdude: 1 bytes of lfuse written

avrdude: verifying lfuse memory against 0xFF:

avrdude: load data lfuse data from input file 0xFF:

avrdude: input file 0xFF contains 1 bytes

avrdude: reading on-chip lfuse data:



Reading | ################################################## | 100% 0.02s



avrdude: verifying ...

avrdude: 1 bytes of lfuse verified



avrdude: safemode: Fuses OK (E:FF, H:DF, L:FF)



avrdude done.  Thank you.</div><br>

<p>Once finished, to verify that the FabISP has been programmed properly, just go in the System Profiler> Hardware> USB> Hubs: if all went well, FabISP" should be listed in the hub menu.</p>
<p class="pic"><img src= "Image/Lesson04/FabISP_rilevata.jpg" class="img-responsive" alt="Responsive image"></p>
<p>After you have programmed the board, you have to remove the 0 ohm resistor and solder bridge. Now you can use it as a programmer to program other boards.
</p>

    <p></p>
        </div>
    <!-- End of your content -->

    </div> <!-- /container -->

	<!-- footer -->
    
    <footer id="footer">
        <p id="cclicense">
        </p>
        <p class="license">
        Theme: <a href="https://github.com/openp2pdesign/FabAcademy_Template">Fab Academy Template</a> by <a href="http://openp2pdesign.org">Massimo Menichinelli</a> <br>
        Based on <a href="http://getbootstrap.com/">Twitter Bootstrap</a>+<a href="http://jquery.com/">JQuery</a>+<a href="https://code.google.com/p/google-code-prettify/">google-code-prettify</a>+<a href="http://jmblog.github.io/color-themes-for-google-code-prettify/github/">GitHub theme for google-code-prettify</a>+<a href="https://code.google.com/p/jsc3d/">JSC3D</a>+<a href="https://github.com/thegrubbsian/jquery.ganttView">jquery.ganttView</a>.
        </p>
    </footer>
    

	<!-- Do not touch this! -->
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="media/jquery-1.9.1.min.js"></script>
    
    <!-- Syntax Highlighter -->
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js">
    </script>
    <!-- From https://github.com/jmblog/color-themes-for-google-code-prettify -->
    <link href="media/github.css" type="text/css" rel="stylesheet">
	<script type="text/javascript">
	  !function ($) {
		$(function(){
		  window.prettyPrint && prettyPrint()   
		})
	  }(window.jQuery)
	</script>
	
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="bootstrap/js/ie10-viewport-bug-workaround.js"></script>

  </body>
</html>
